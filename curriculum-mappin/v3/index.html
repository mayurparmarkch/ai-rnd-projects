<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Step 1 - Extract PDF Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col items-center py-10">
    <div class="bg-white shadow-lg rounded-xl p-8 w-full max-w-3xl">
      <h1 class="text-2xl font-bold text-blue-600 mb-6 text-center">
        Step 1: Extract Data from PDF
      </h1>
      <form id="extractForm" class="space-y-4">
        <input
          type="file"
          name="file"
          accept="application/pdf"
          required
          class="block w-full border rounded-lg p-2"
        />
        <button
          type="submit"
          class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold"
        >
          Extract Data
        </button>
      </form>
      <div id="result" class="mt-6 hidden">
        <h3 class="text-lg font-semibold">Extracted Data:</h3>
        <div class="overflow-auto max-h-[400px]">
          <table class="w-full text-sm border">
            <thead class="bg-gray-200">
              <tr>
                <th class="px-3 py-2">Chapter</th>
                <th class="px-3 py-2">Title</th>
                <th class="px-3 py-2">Topic</th>
                <th class="px-3 py-2">Description</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <button
          id="mapButton"
          class="mt-4 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg hidden"
        >
          Go to Mapping Page →
        </button>
      </div>
    </div>

    <script>
      let pdfHash = "";
      document
        .getElementById("extractForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const resBox = document.getElementById("result");
          const tbody = document.getElementById("tableBody");
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">⏳ Extracting...</td></tr>`;
          resBox.classList.remove("hidden");

          try {
            const res = await fetch("http://localhost:5000/extract", {
              method: "POST",
              body: formData,
            });
            const data = await res.json();
            if (data.error) {
              tbody.innerHTML = `<tr><td colspan="4" class="text-red-500">${data.error}</td></tr>`;
              return;
            }
            pdfHash = data.hash;
            console.log("data-->", data);
            console.log("pdfHash-->", pdfHash);

            tbody.innerHTML = data.data
              .map(
                (d) =>
                  `<tr>
            <td class="border px-3 py-1">${d.chapter || "-"}</td>
            <td class="border px-3 py-1">${d.title || "-"}</td>
            <td class="border px-3 py-1">${d.topic || "-"}</td>
            <td class="border px-3 py-1">${d.description || "-"}</td>
          </tr>`
              )
              .join("");

            const btn = document.getElementById("mapButton");
            btn.classList.remove("hidden");
            btn.onclick = () => {
              window.location.href = `/v3/map.html?hash=${pdfHash}`;
            };
          } catch (err) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-red-500">${err}</td></tr>`;
          }
        });
    </script>
  </body>
</html>
